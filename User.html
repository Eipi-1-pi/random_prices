<!-- File: User.html -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('UserStyles'); ?>
</head>
<body>
  <div class="container">
    <h1>Price Generator</h1>
    
    <!-- Sales Options Section -->
    <div id="optionsSection">
      <h3>Select Sales Options</h3>
      <form id="salesForm">
        <table id="salesOptionsTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>Option Number</th>
              <th>Name</th>
              <th>Selling Price (售價)</th>
              <th>Quantity</th>
            </tr>
          </thead>
          <tbody>
            <!-- Sales options will be dynamically loaded here -->
          </tbody>
        </table>
      </form>
    </div>
    
    <!-- Generate Price Button -->
    <div id="inputSection">
      <button type="button" onclick="generateInitialPrice()" class="spin-btn">Generate Price</button>
    </div>
    
    <!-- Animation Section -->
    <div id="animationSection" class="animation-section" style="display: none;">
      <h3>Calculating...</h3>
      <div class="loader"></div> <!-- Simple loader animation -->
    </div>
    
    <!-- Offer Selection Section -->
    <div id="offerSelectionSection" class="offer-selection-section" style="display: none;">
      <h3>Select Your Preferred Offer</h3>
      <form id="offerForm">
        <table id="offersTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>Offer Details</th>
            </tr>
          </thead>
          <tbody>
            <!-- Offer options will be dynamically loaded here -->
          </tbody>
        </table>
        <button type="button" onclick="applySelectedOffer()" class="apply-btn">Apply Offer</button>
      </form>
    </div>
    
    <!-- Result Section -->
    <div id="resultSection" class="result-section" style="display: none;">
      <h3>Amount to Pay:</h3>
      <p><strong>Total Final Price:</strong> $<span id="totalFinalPrice"></span></p>
      <p><strong>Bonus Bottles:</strong> <span id="bonusBottles"></span></p>
    </div>
    
    <!-- Feedback Messages -->
    <div class="message" id="message" style="display: none;"></div>
    
    <!-- Admin Modal -->
    <div id="adminModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeAdminModal()">&times;</span>
        
        <!-- Login Section -->
        <div id="loginSection">
          <h3>Admin Login</h3>
          <input type="password" id="adminPassword" placeholder="Enter Admin Password" />
          <button onclick="validateAdmin()" class="admin-btn">Login</button>
          <p id="adminError" class="error-message" style="display: none;">Invalid password. Please try again.</p>
        </div>
        
        <!-- Settings Section -->
        <div id="settingsSection" style="display: none;">
          <h3>Configure Sales Options</h3>
          
          <!-- Sales Options Table -->
          <button onclick="addSalesOptionRowAdmin()" class="add-btn">Add Sales Option</button>
          <table id="salesOptionsTableAdmin" class="sales-options-table">
            <thead>
              <tr>
                <th>Number</th>
                <th>Name</th>
                <th>Cost (成本)</th>
                <th>Selling Price (售價)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Sales options will be dynamically loaded here -->
            </tbody>
          </table>
          
          <!-- Save Sales Options Button -->
          <button onclick="saveSalesOptions()" class="admin-btn">Save Sales Options</button>
          
          <!-- Success Message -->
          <p id="successMessage" class="success-message" style="display: none;">Sales Options saved successfully!</p>
        </div>
        
        <!-- Unlock Section -->
        <div id="unlockSection" style="display: none; margin-top: 30px;">
          <h3>Unlock a User</h3>
          <input type="text" id="unlockUserId" placeholder="Enter User ID to Unlock" />
          <button onclick="adminUnlockUser()" class="admin-btn">Unlock</button>
          <p id="unlockError" class="error-message" style="display: none;">Unable to unlock. Please check the User ID.</p>
          <p id="unlockSuccess" class="success-message" style="display: none;">User unlocked successfully!</p>
        </div>
        
        <!-- Button to Switch to Unlock Section -->
        <button onclick="showUnlockSection()" class="admin-btn" style="margin-top: 20px;">Unlock a User</button>
      </div>
    </div>
  </div>
  
  <!-- Embed User Identification and IP Logging Script -->
  <script>
    let userId = '';
    
    /**
     * Generates a UUIDv4.
     * @return {string} - A UUID string.
     */
    function generateUUID() { // Public Domain/MIT
      var d = new Date().getTime();//Timestamp
      var d2 = (performance && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16;//random number between 0 and 16
          if(d > 0){
              r = (d + r)%16 | 0;
              d = Math.floor(d/16);
          } else {
              r = (d2 + r)%16 | 0;
              d2 = Math.floor(d2/16);
          }
          return (c==='x' ? r : (r&0x3|0x8)).toString(16);
      });
    }

    /**
     * Assigns a unique user ID to each user and stores it in localStorage.
     */
    function assignUserId() {
      userId = localStorage.getItem('uniqueUserId');
      if (!userId) {
        userId = generateUUID();
        localStorage.setItem('uniqueUserId', userId);
      }
    }

    /**
     * Fetches the visitor's IP address using a public API and sends it to the server-side logIP function.
     * Additionally, assigns and logs a unique user ID.
     */
    function fetchAndLogIP() {
      // Assign unique user ID
      assignUserId();

      // Use a reliable IP detection service. Here, we use ipify.org as an example.
      fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
          const userIP = data.ip;
          // Send the IP and User ID to the server-side logIP function
          google.script.run
            .withSuccessHandler(function() {
              console.log('IP address and User ID logged successfully:', userIP, userId);
            })
            .withFailureHandler(function(error) {
              console.error('Error logging IP address and User ID:', error);
            })
            .logIP(userIP, userId);
          
          // Check if User ID is locked
          google.script.run
            .withSuccessHandler(function(isLocked) {
              if (isLocked) {
                disableGenerateButton();
                alert('You have already generated a price.');
              }
            })
            .withFailureHandler(function(error) {
              console.error('Error checking User lock status:', error);
            })
            .isUserLocked(userId);
        })
        .catch(error => {
          console.error('Error fetching IP address:', error);
        });
    }

    // Call the fetchAndLogIP function when the page loads
    window.onload = function() {
      fetchAndLogIP();
    };
  </script>
  
  <!-- Main JavaScript Code -->
  <script>
    let offers = []; // To store offers received from the server
    let selectedOptions = []; // To store selected options

    /**
     * Initializes the UI by fetching sales options from the server.
     */
    function initialize() {
      google.script.run
        .withSuccessHandler(function(salesOptionsData) {
          loadSalesOptions(salesOptionsData);
        })
        .withFailureHandler(function(error) {
          console.error('Error fetching sales options:', error);
          alert('Failed to load sales options. Please try again later.');
        })
        .getSalesOptions();
    }
  
    /**
     * Populates the sales options table in the user interface.
     * @param {Array} salesOptionsData - Array of sales option objects.
     */
    function loadSalesOptions(salesOptionsData) {
      const tableBody = document.getElementById('salesOptionsTable').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows
      
      if (salesOptionsData.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = 'No sales options available. Please contact the administrator.';
        tr.appendChild(td);
        tableBody.appendChild(tr);
        return;
      }
      
      salesOptionsData.forEach(option => {
        console.log('Adding Sales Option:', option); // Debugging line
        addSalesOptionRow(option.number, option.name, option.sellingPrice);
      });
    }
  
    /**
     * Adds a sales option row to the sales options table.
     * @param {number} number - The option number.
     * @param {string} name - The product name.
     * @param {number} sellingPrice - The selling price of the product.
     */
    function addSalesOptionRow(number, name, sellingPrice) {
      const tableBody = document.getElementById('salesOptionsTable').getElementsByTagName('tbody')[0];
      const tr = document.createElement('tr');
      
      // Select Checkbox
      const selectTd = document.createElement('td');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'selectedOptions';
      checkbox.value = number;
      selectTd.appendChild(checkbox);
      tr.appendChild(selectTd);
      
      // Option Number
      const numberTd = document.createElement('td');
      numberTd.textContent = number;
      tr.appendChild(numberTd);
      
      // Name
      const nameTd = document.createElement('td');
      nameTd.textContent = name;
      tr.appendChild(nameTd);
      
      // Selling Price
      const sellingPriceTd = document.createElement('td');
      // Ensure sellingPrice is a valid number
      if (isNaN(sellingPrice)) {
        sellingPriceTd.textContent = 'N/A';
        sellingPriceTd.style.color = 'red';
      } else {
        sellingPriceTd.textContent = `$${sellingPrice.toFixed(2)}`;
      }
      tr.appendChild(sellingPriceTd);
      
      // Quantity Input
      const quantityTd = document.createElement('td');
      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.min = '1';
      quantityInput.step = '1';
      quantityInput.value = '1';
      quantityInput.disabled = true; // Disabled until checkbox is checked
      quantityInput.id = `quantity_${number}`;
      quantityTd.appendChild(quantityInput);
      tr.appendChild(quantityTd);
      
      // Enable quantity input when checkbox is checked
      checkbox.addEventListener('change', function() {
        quantityInput.disabled = !this.checked;
        if (!this.checked) {
          quantityInput.value = '1';
        }
      });
      
      tableBody.appendChild(tr);
    }
  
    /**
     * Generates the initial price and retrieves offer options based on the total quantity.
     */
    function generateInitialPrice() {
      const generateButton = document.querySelector('.spin-btn');
      
      // Check if button is already disabled
      if (generateButton.disabled) {
        alert('You have already generated your price.');
        return;
      }
      
      const selectedCheckboxes = document.querySelectorAll('input[name="selectedOptions"]:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one sales option.');
        return;
      }
      
      const selectedOptionsArray = [];
      selectedCheckboxes.forEach(checkbox => {
        const optionNumber = parseInt(checkbox.value, 10);
        const quantityInput = document.getElementById(`quantity_${optionNumber}`);
        const quantity = parseInt(quantityInput.value, 10);
        if (isNaN(quantity) || quantity < 1) {
          alert(`Please enter a valid quantity for option ${optionNumber}.`);
          throw new Error(`Invalid quantity for option ${optionNumber}.`);
        }
        selectedOptionsArray.push({ optionNumber, quantity });
      });
      
      // Disable the button to prevent multiple presses
      generateButton.disabled = true;
      generateButton.textContent = 'Generating...';
      
      // Reset previous results and offers
      offers = [];
      selectedOptions = selectedOptionsArray;
      document.getElementById('resultSection').style.display = 'none';
      document.getElementById('offerSelectionSection').style.display = 'none';
      
      // Start animation section
      document.getElementById('animationSection').style.display = 'block';
      
      // Initiate server call to generate offers
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.autoApply) {
            // Automatically apply the single available offer
            const autoResult = result.result;
            document.getElementById('animationSection').style.display = 'none';
            displayResults(autoResult);
          } else {
            offers = result.offers;
            document.getElementById('animationSection').style.display = 'none';
            displayOffers(offers);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error generating offers:', error);
          alert(error.message || 'An error occurred while generating offers. Please try again.');
          document.getElementById('animationSection').style.display = 'none';
          // Re-enable the button in case of failure
          generateButton.disabled = false;
          generateButton.textContent = 'Generate Price';
        })
        .generateFinalPrices(selectedOptionsArray, userId);
    }
  
    /**
     * Displays the generated offers for the user to select.
     * @param {Array} offersData - Array of offer objects.
     */
    function displayOffers(offersData) {
      if (offersData.length === 0) {
        alert('No offers available for your selection.');
        const generateButton = document.querySelector('.spin-btn');
        generateButton.disabled = false;
        generateButton.textContent = 'Generate Price';
        return;
      }
      
      const offersSection = document.getElementById('offerSelectionSection');
      const offersTableBody = document.getElementById('offersTable').getElementsByTagName('tbody')[0];
      offersTableBody.innerHTML = ''; // Clear existing rows
      
      offersData.forEach((offer, index) => {
        const tr = document.createElement('tr');
        
        // Select Radio Button
        const selectTd = document.createElement('td');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.id = 'offer-' + index;
        radio.name = 'selectedOffer';
        radio.value = index; // Use index to identify the offer
        if (index === 0) radio.checked = true; // Select the first offer by default
        selectTd.appendChild(radio);
        tr.appendChild(selectTd);
        
        // Offer Details
        const descTd = document.createElement('td');
        let offerText = '';
        if (offer.bonusBottles > 0) {
          offerText += `Bonus Bottles: ${offer.bonusBottles}`;
        }
        if (offer.deductions > 0) {
          if (offerText.length > 0) offerText += ', ';
          offerText += `Discount: $${offer.deductions}`;
        }
        if (offerText.length === 0) {
          offerText = 'No Offer';
        }
        descTd.textContent = offerText;
        tr.appendChild(descTd);
        
        offersTableBody.appendChild(tr);
      });
      
      // Show the offer selection section
      offersSection.style.display = 'block';
    }
  
    /**
     * Applies the selected offer by sending the choice to the server.
     */
    function applySelectedOffer() {
      const selectedRadio = document.querySelector('input[name="selectedOffer"]:checked');
      if (!selectedRadio) {
        alert('Please select an offer.');
        return;
      }
      
      const chosenIndex = parseInt(selectedRadio.value, 10);
      const chosenOffer = offers[chosenIndex];
      
      if (!chosenOffer) {
        alert('Invalid offer selected. Please try again.');
        return;
      }
      
      // Show animation
      document.getElementById('animationSection').style.display = 'block';
      document.getElementById('offerSelectionSection').style.display = 'none';
      
      // Initiate server call to apply the chosen offer
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('animationSection').style.display = 'none';
          displayResults({
            totalFinalPrice: result.totalFinalPrice,
            bonusBottles: result.bonusBottles
          });
        })
        .withFailureHandler(function(error) {
          console.error('Error applying chosen offer:', error);
          alert(error.message || 'An error occurred while applying the offer. Please try again.');
          document.getElementById('animationSection').style.display = 'none';
          document.getElementById('offerSelectionSection').style.display = 'block';
        })
        .applyChosenOffer(selectedOptions, userId, chosenOffer);
    }
  
    /**
     * Displays the final results to the user, including the final price and bonus bottles.
     * @param {Object} result - The result object containing final prices and summaries.
     */
    function displayResults(result) {
      document.getElementById('totalFinalPrice').textContent = result.totalFinalPrice;
      document.getElementById('bonusBottles').textContent = result.bonusBottles;
      document.getElementById('resultSection').style.display = 'block';
    }
  
    /**
     * Disables the "Generate Price" button and updates its text.
     */
    function disableGenerateButton() {
      const generateButton = document.querySelector('.spin-btn');
      generateButton.disabled = true;
      generateButton.textContent = 'Price Generated';
    }
  
    /**
     * Opens the Admin Modal.
     */
    function openAdminModal() {
      const modal = document.getElementById('adminModal');
      modal.style.display = 'block';
    }
  
    /**
     * Closes the Admin Modal.
     */
    function closeAdminModal() {
      const modal = document.getElementById('adminModal');
      modal.style.display = 'none';
      resetAdminModal();
    }
  
    /**
     * Resets the Admin Modal to its initial state.
     */
    function resetAdminModal() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('settingsSection').style.display = 'none';
      document.getElementById('unlockSection').style.display = 'none';
      document.getElementById('adminError').style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0].innerHTML = '';
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('unlockSuccess').style.display = 'none';
      document.getElementById('unlockError').style.display = 'none';
    }
  
    /**
     * Validates the admin password.
     */
    function validateAdmin() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        alert('Please enter the admin password.');
        return;
      }
      google.script.run
        .withSuccessHandler(function(isValid) {
          if (isValid) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'block';
            document.getElementById('unlockSection').style.display = 'none';
            loadAdminSettings();
          } else {
            document.getElementById('adminError').style.display = 'block';
          }
        })
        .validateAdminPassword(password);
    }
  
    /**
     * Loads existing sales options and populates the table in Admin Panel.
     */
    function loadAdminSettings() {
      google.script.run
        .withSuccessHandler(function(salesOptionsData) {
          loadSalesOptionsAdmin(salesOptionsData);
        })
        .getSalesOptions();
    }
  
    /**
     * Loads sales options into the sales options table in Admin Panel.
     * @param {Array} salesOptionsData - Array of sales options.
     */
    function loadSalesOptionsAdmin(salesOptionsData) {
      const tableBody = document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows
      
      salesOptionsData.forEach(option => {
        addSalesOptionRowAdmin(option.number, option.name, option.cost, option.sellingPrice);
      });
    }
  
    /**
     * Adds a sales option row to the sales options table in Admin Panel with editable fields.
     * @param {number} number - The option number.
     * @param {string} name - The product name.
     * @param {number} cost - The cost of the product.
     * @param {number} sellingPrice - The selling price of the product.
     */
    function addSalesOptionRowAdmin(number = '', name = '', cost = '', sellingPrice = '') {
      const tableBody = document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0];
      const tr = document.createElement('tr');
      
      // Number Cell (Editable)
      const numberTd = document.createElement('td');
      const numberInput = document.createElement('input');
      numberInput.type = 'number';
      numberInput.min = '1';
      numberInput.step = '1';
      numberInput.value = number;
      numberInput.required = true;
      numberTd.appendChild(numberInput);
      tr.appendChild(numberTd);
      
      // Name Cell (Editable)
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name;
      nameInput.required = true;
      nameTd.appendChild(nameInput);
      tr.appendChild(nameTd);
      
      // Cost Cell (Editable)
      const costTd = document.createElement('td');
      const costInput = document.createElement('input');
      costInput.type = 'number';
      costInput.min = '0';
      costInput.step = '0.01';
      costInput.value = cost;
      costInput.required = true;
      costTd.appendChild(costInput);
      tr.appendChild(costTd);
      
      // Selling Price Cell (Editable)
      const sellingPriceTd = document.createElement('td');
      const sellingPriceInput = document.createElement('input');
      sellingPriceInput.type = 'number';
      sellingPriceInput.min = '0';
      sellingPriceInput.step = '0.01';
      sellingPriceInput.value = sellingPrice;
      sellingPriceInput.required = true;
      sellingPriceTd.appendChild(sellingPriceInput);
      tr.appendChild(sellingPriceTd);
      
      // Actions Cell
      const actionsTd = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = function() {
        if (confirm('Are you sure you want to delete this sales option?')) {
          tableBody.removeChild(tr);
        }
      };
      actionsTd.appendChild(deleteBtn);
      tr.appendChild(actionsTd);
      
      tableBody.appendChild(tr);
    }
  
    /**
     * Saves sales options to the server and provides feedback.
     */
    function saveSalesOptions() {
      // Collect sales options
      const salesOptionsTable = document.getElementById('salesOptionsTableAdmin');
      const salesOptionRows = salesOptionsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      const numbers = [];
      const names = [];
      const costs = [];
      const sellingPrices = [];
      
      for (let i = 0; i < salesOptionRows.length; i++) {
        const numberInput = salesOptionRows[i].cells[0].getElementsByTagName('input')[0];
        const nameInput = salesOptionRows[i].cells[1].getElementsByTagName('input')[0];
        const costInput = salesOptionRows[i].cells[2].getElementsByTagName('input')[0];
        const sellingPriceInput = salesOptionRows[i].cells[3].getElementsByTagName('input')[0];
        
        const number = parseInt(numberInput.value, 10);
        const name = nameInput.value.trim();
        const cost = parseFloat(costInput.value);
        const sellingPrice = parseFloat(sellingPriceInput.value);
        
        if (isNaN(number) || number <= 0) {
          alert(`Invalid number in Sales Option row ${i + 1}. Please enter a positive integer.`);
          return;
        }
        if (!name) {
          alert(`Invalid name in Sales Option row ${i + 1}. Please enter a non-empty name.`);
          return;
        }
        if (isNaN(cost) || cost < 0) {
          alert(`Invalid cost in Sales Option row ${i + 1}. Please enter a non-negative number.`);
          return;
        }
        if (isNaN(sellingPrice) || sellingPrice < 0) {
          alert(`Invalid selling price in Sales Option row ${i + 1}. Please enter a non-negative number.`);
          return;
        }
        
        numbers.push(number);
        names.push(name);
        costs.push(cost);
        sellingPrices.push(sellingPrice);
      }
      
      // Save sales options to server
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('successMessage').textContent = 'Sales Options saved successfully!';
          document.getElementById('successMessage').style.display = 'block';
          setTimeout(() => {
            document.getElementById('successMessage').style.display = 'none';
          }, 3000);
        })
        .withFailureHandler(function(error) {
          console.error('Error saving sales options:', error);
          alert('An error occurred while saving sales options. Please try again.');
        })
        .saveSalesOptions({ numbers, names, costs, sellingPrices });
    }
  
    /**
     * Handles unlocking a user by User ID.
     */
    function adminUnlockUser() {
      const userToUnlock = document.getElementById('unlockUserId').value.trim();
      if (!userToUnlock) {
        alert('Please enter a User ID.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('unlockSuccess').style.display = 'block';
          document.getElementById('unlockError').style.display = 'none';
          document.getElementById('unlockUserId').value = '';
          // Optionally, hide the success message after a delay
          setTimeout(() => {
            document.getElementById('unlockSuccess').style.display = 'none';
          }, 3000);
        })
        .withFailureHandler(function(error) {
          console.error('Error unlocking User ID:', error);
          document.getElementById('unlockError').style.display = 'block';
          document.getElementById('unlockSuccess').style.display = 'none';
        })
        .unlockUser(userToUnlock);
    }
  
    /**
     * Shows the Unlock Section in the Admin Modal.
     */
    function showUnlockSection() {
      document.getElementById('settingsSection').style.display = 'none';
      document.getElementById('unlockSection').style.display = 'block';
    }
  
    /**
     * Handles the keyboard shortcut for opening the Admin Modal.
     * Changed from Ctrl + B to Ctrl + Shift + B to avoid browser conflicts.
     */
    document.addEventListener('keydown', function (event) {
      // Use Ctrl + Shift + B instead of Ctrl + B
      if (event.ctrlKey && event.shiftKey && (event.key === 'B' || event.key === 'b')) {
        event.preventDefault();
        openAdminModal();
        console.log('Admin Modal opened via Ctrl + Shift + B');
      }
    });
  
    /**
     * Closes the Admin Modal when clicking outside of the modal content.
     */
    window.onclick = function(event) {
      const modal = document.getElementById('adminModal');
      if (event.target == modal) {
        closeAdminModal();
      }
    }
  
    /**
     * Opens the Admin Modal.
     */
    function openAdminModal() {
      const modal = document.getElementById('adminModal');
      modal.style.display = 'block';
    }
  
    /**
     * Closes the Admin Modal.
     */
    function closeAdminModal() {
      const modal = document.getElementById('adminModal');
      modal.style.display = 'none';
      resetAdminModal();
    }
  
    /**
     * Resets the Admin Modal to its initial state.
     */
    function resetAdminModal() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('settingsSection').style.display = 'none';
      document.getElementById('unlockSection').style.display = 'none';
      document.getElementById('adminError').style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0].innerHTML = '';
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('unlockSuccess').style.display = 'none';
      document.getElementById('unlockError').style.display = 'none';
    }
  
    /**
     * Validates the admin password.
     */
    function validateAdmin() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        alert('Please enter the admin password.');
        return;
      }
      google.script.run
        .withSuccessHandler(function(isValid) {
          if (isValid) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'block';
            document.getElementById('unlockSection').style.display = 'none';
            loadAdminSettings();
          } else {
            document.getElementById('adminError').style.display = 'block';
          }
        })
        .validateAdminPassword(password);
    }
  
    /**
     * Loads existing sales options and populates the table in Admin Panel.
     */
    function loadAdminSettings() {
      google.script.run
        .withSuccessHandler(function(salesOptionsData) {
          loadSalesOptionsAdmin(salesOptionsData);
        })
        .getSalesOptions();
    }
  
    /**
     * Loads sales options into the sales options table in Admin Panel.
     * @param {Array} salesOptionsData - Array of sales options.
     */
    function loadSalesOptionsAdmin(salesOptionsData) {
      const tableBody = document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows
      
      salesOptionsData.forEach(option => {
        addSalesOptionRowAdmin(option.number, option.name, option.cost, option.sellingPrice);
      });
    }
  
    /**
     * Adds a sales option row to the sales options table in Admin Panel with editable fields.
     * @param {number} number - The option number.
     * @param {string} name - The product name.
     * @param {number} cost - The cost of the product.
     * @param {number} sellingPrice - The selling price of the product.
     */
    function addSalesOptionRowAdmin(number = '', name = '', cost = '', sellingPrice = '') {
      const tableBody = document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0];
      const tr = document.createElement('tr');
      
      // Number Cell (Editable)
      const numberTd = document.createElement('td');
      const numberInput = document.createElement('input');
      numberInput.type = 'number';
      numberInput.min = '1';
      numberInput.step = '1';
      numberInput.value = number;
      numberInput.required = true;
      numberTd.appendChild(numberInput);
      tr.appendChild(numberTd);
      
      // Name Cell (Editable)
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name;
      nameInput.required = true;
      nameTd.appendChild(nameInput);
      tr.appendChild(nameTd);
      
      // Cost Cell (Editable)
      const costTd = document.createElement('td');
      const costInput = document.createElement('input');
      costInput.type = 'number';
      costInput.min = '0';
      costInput.step = '0.01';
      costInput.value = cost;
      costInput.required = true;
      costTd.appendChild(costInput);
      tr.appendChild(costTd);
      
      // Selling Price Cell (Editable)
      const sellingPriceTd = document.createElement('td');
      const sellingPriceInput = document.createElement('input');
      sellingPriceInput.type = 'number';
      sellingPriceInput.min = '0';
      sellingPriceInput.step = '0.01';
      sellingPriceInput.value = sellingPrice;
      sellingPriceInput.required = true;
      sellingPriceTd.appendChild(sellingPriceInput);
      tr.appendChild(sellingPriceTd);
      
      // Actions Cell
      const actionsTd = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = function() {
        if (confirm('Are you sure you want to delete this sales option?')) {
          tableBody.removeChild(tr);
        }
      };
      actionsTd.appendChild(deleteBtn);
      tr.appendChild(actionsTd);
      
      tableBody.appendChild(tr);
    }
  
    /**
     * Saves sales options to the server and provides feedback.
     */
    function saveSalesOptions() {
      // Collect sales options
      const salesOptionsTable = document.getElementById('salesOptionsTableAdmin');
      const salesOptionRows = salesOptionsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      const numbers = [];
      const names = [];
      const costs = [];
      const sellingPrices = [];
      
      for (let i = 0; i < salesOptionRows.length; i++) {
        const numberInput = salesOptionRows[i].cells[0].getElementsByTagName('input')[0];
        const nameInput = salesOptionRows[i].cells[1].getElementsByTagName('input')[0];
        const costInput = salesOptionRows[i].cells[2].getElementsByTagName('input')[0];
        const sellingPriceInput = salesOptionRows[i].cells[3].getElementsByTagName('input')[0];
        
        const number = parseInt(numberInput.value, 10);
        const name = nameInput.value.trim();
        const cost = parseFloat(costInput.value);
        const sellingPrice = parseFloat(sellingPriceInput.value);
        
        if (isNaN(number) || number <= 0) {
          alert(`Invalid number in Sales Option row ${i + 1}. Please enter a positive integer.`);
          return;
        }
        if (!name) {
          alert(`Invalid name in Sales Option row ${i + 1}. Please enter a non-empty name.`);
          return;
        }
        if (isNaN(cost) || cost < 0) {
          alert(`Invalid cost in Sales Option row ${i + 1}. Please enter a non-negative number.`);
          return;
        }
        if (isNaN(sellingPrice) || sellingPrice < 0) {
          alert(`Invalid selling price in Sales Option row ${i + 1}. Please enter a non-negative number.`);
          return;
        }
        
        numbers.push(number);
        names.push(name);
        costs.push(cost);
        sellingPrices.push(sellingPrice);
      }
      
      // Save sales options to server
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('successMessage').textContent = 'Sales Options saved successfully!';
          document.getElementById('successMessage').style.display = 'block';
          setTimeout(() => {
            document.getElementById('successMessage').style.display = 'none';
          }, 3000);
        })
        .withFailureHandler(function(error) {
          console.error('Error saving sales options:', error);
          alert('An error occurred while saving sales options. Please try again.');
        })
        .saveSalesOptions({ numbers, names, costs, sellingPrices });
    }
  
    /**
     * Handles unlocking a user by User ID.
     */
    function adminUnlockUser() {
      const userToUnlock = document.getElementById('unlockUserId').value.trim();
      if (!userToUnlock) {
        alert('Please enter a User ID.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('unlockSuccess').style.display = 'block';
          document.getElementById('unlockError').style.display = 'none';
          document.getElementById('unlockUserId').value = '';
          // Optionally, hide the success message after a delay
          setTimeout(() => {
            document.getElementById('unlockSuccess').style.display = 'none';
          }, 3000);
        })
        .withFailureHandler(function(error) {
          console.error('Error unlocking User ID:', error);
          document.getElementById('unlockError').style.display = 'block';
          document.getElementById('unlockSuccess').style.display = 'none';
        })
        .unlockUser(userToUnlock);
    }
  
    /**
     * Shows the Unlock Section in the Admin Modal.
     */
    function showUnlockSection() {
      document.getElementById('settingsSection').style.display = 'none';
      document.getElementById('unlockSection').style.display = 'block';
    }
  
    /**
     * Handles the keyboard shortcut for opening the Admin Modal.
     * Changed from Ctrl + B to Ctrl + Shift + B to avoid browser conflicts.
     */
    document.addEventListener('keydown', function (event) {
      // Use Ctrl + Shift + B instead of Ctrl + B
      if (event.ctrlKey && event.shiftKey && (event.key === 'B' || event.key === 'b')) {
        event.preventDefault();
        openAdminModal();
        console.log('Admin Modal opened via Ctrl + Shift + B');
      }
    });
  
    /**
     * Closes the Admin Modal when clicking outside of the modal content.
     */
    window.onclick = function(event) {
      const modal = document.getElementById('adminModal');
      if (event.target == modal) {
        closeAdminModal();
      }
    }
  
    /**
     * Opens the Admin Modal.
     */
    function openAdminModal() {
      const modal = document.getElementById('adminModal');
      modal.style.display = 'block';
    }
  
    /**
     * Closes the Admin Modal.
     */
    function closeAdminModal() {
      const modal = document.getElementById('adminModal');
      modal.style.display = 'none';
      resetAdminModal();
    }
  
    /**
     * Resets the Admin Modal to its initial state.
     */
    function resetAdminModal() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('settingsSection').style.display = 'none';
      document.getElementById('unlockSection').style.display = 'none';
      document.getElementById('adminError').style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0].innerHTML = '';
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('unlockSuccess').style.display = 'none';
      document.getElementById('unlockError').style.display = 'none';
    }
  
    /**
     * Validates the admin password.
     */
    function validateAdmin() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        alert('Please enter the admin password.');
        return;
      }
      google.script.run
        .withSuccessHandler(function(isValid) {
          if (isValid) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'block';
            document.getElementById('unlockSection').style.display = 'none';
            loadAdminSettings();
          } else {
            document.getElementById('adminError').style.display = 'block';
          }
        })
        .validateAdminPassword(password);
    }
  
    /**
     * Loads existing sales options and populates the table in Admin Panel.
     */
    function loadAdminSettings() {
      google.script.run
        .withSuccessHandler(function(salesOptionsData) {
          loadSalesOptionsAdmin(salesOptionsData);
        })
        .getSalesOptions();
    }
  
    /**
     * Loads sales options into the sales options table in Admin Panel.
     * @param {Array} salesOptionsData - Array of sales options.
     */
    function loadSalesOptionsAdmin(salesOptionsData) {
      const tableBody = document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows
      
      salesOptionsData.forEach(option => {
        addSalesOptionRowAdmin(option.number, option.name, option.cost, option.sellingPrice);
      });
    }
  
    /**
     * Adds a sales option row to the sales options table in Admin Panel with editable fields.
     * @param {number} number - The option number.
     * @param {string} name - The product name.
     * @param {number} cost - The cost of the product.
     * @param {number} sellingPrice - The selling price of the product.
     */
    function addSalesOptionRowAdmin(number = '', name = '', cost = '', sellingPrice = '') {
      const tableBody = document.getElementById('salesOptionsTableAdmin').getElementsByTagName('tbody')[0];
      const tr = document.createElement('tr');
      
      // Number Cell (Editable)
      const numberTd = document.createElement('td');
      const numberInput = document.createElement('input');
      numberInput.type = 'number';
      numberInput.min = '1';
      numberInput.step = '1';
      numberInput.value = number;
      numberInput.required = true;
      numberTd.appendChild(numberInput);
      tr.appendChild(numberTd);
      
      // Name Cell (Editable)
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name;
      nameInput.required = true;
      nameTd.appendChild(nameInput);
      tr.appendChild(nameTd);
      
      // Cost Cell (Editable)
      const costTd = document.createElement('td');
      const costInput = document.createElement('input');
      costInput.type = 'number';
      costInput.min = '0';
      costInput.step = '0.01';
      costInput.value = cost;
      costInput.required = true;
      costTd.appendChild(costInput);
      tr.appendChild(costTd);
      
      // Selling Price Cell (Editable)
      const sellingPriceTd = document.createElement('td');
      const sellingPriceInput = document.createElement('input');
      sellingPriceInput.type = 'number';
      sellingPriceInput.min = '0';
      sellingPriceInput.step = '0.01';
      sellingPriceInput.value = sellingPrice;
      sellingPriceInput.required = true;
      sellingPriceTd.appendChild(sellingPriceInput);
      tr.appendChild(sellingPriceTd);
      
      // Actions Cell
      const actionsTd = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';
      deleteBtn.onclick = function() {
        if (confirm('Are you sure you want to delete this sales option?')) {
          tableBody.removeChild(tr);
        }
      };
      actionsTd.appendChild(deleteBtn);
      tr.appendChild(actionsTd);
      
      tableBody.appendChild(tr);
    }
  
    /**
     * Saves sales options to the server and provides feedback.
     */
    function saveSalesOptions() {
      // Collect sales options
      const salesOptionsTable = document.getElementById('salesOptionsTableAdmin');
      const salesOptionRows = salesOptionsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      const numbers = [];
      const names = [];
      const costs = [];
      const sellingPrices = [];
      
      for (let i = 0; i < salesOptionRows.length; i++) {
        const numberInput = salesOptionRows[i].cells[0].getElementsByTagName('input')[0];
        const nameInput = salesOptionRows[i].cells[1].getElementsByTagName('input')[0];
        const costInput = salesOptionRows[i].cells[2].getElementsByTagName('input')[0];
        const sellingPriceInput = salesOptionRows[i].cells[3].getElementsByTagName('input')[0];
        
        const number = parseInt(numberInput.value, 10);
        const name = nameInput.value.trim();
        const cost = parseFloat(costInput.value);
        const sellingPrice = parseFloat(sellingPriceInput.value);
        
        if (isNaN(number) || number <= 0) {
          alert(`Invalid number in Sales Option row ${i + 1}. Please enter a positive integer.`);
          return;
        }
        if (!name) {
          alert(`Invalid name in Sales Option row ${i + 1}. Please enter a non-empty name.`);
          return;
        }
        if (isNaN(cost) || cost < 0) {
          alert(`Invalid cost in Sales Option row ${i + 1}. Please enter a non-negative number.`);
          return;
        }
        if (isNaN(sellingPrice) || sellingPrice < 0) {
          alert(`Invalid selling price in Sales Option row ${i + 1}. Please enter a non-negative number.`);
          return;
        }
        
        numbers.push(number);
        names.push(name);
        costs.push(cost);
        sellingPrices.push(sellingPrice);
      }
      
      // Save sales options to server
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('successMessage').textContent = 'Sales Options saved successfully!';
          document.getElementById('successMessage').style.display = 'block';
          setTimeout(() => {
            document.getElementById('successMessage').style.display = 'none';
          }, 3000);
        })
        .withFailureHandler(function(error) {
          console.error('Error saving sales options:', error);
          alert('An error occurred while saving sales options. Please try again.');
        })
        .saveSalesOptions({ numbers, names, costs, sellingPrices });
    }
  
    /**
     * Handles unlocking a user by User ID.
     */
    function adminUnlockUser() {
      const userToUnlock = document.getElementById('unlockUserId').value.trim();
      if (!userToUnlock) {
        alert('Please enter a User ID.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('unlockSuccess').style.display = 'block';
          document.getElementById('unlockError').style.display = 'none';
          document.getElementById('unlockUserId').value = '';
          // Optionally, hide the success message after a delay
          setTimeout(() => {
            document.getElementById('unlockSuccess').style.display = 'none';
          }, 3000);
        })
        .withFailureHandler(function(error) {
          console.error('Error unlocking User ID:', error);
          document.getElementById('unlockError').style.display = 'block';
          document.getElementById('unlockSuccess').style.display = 'none';
        })
        .unlockUser(userToUnlock);
    }
  
    /**
     * Shows the Unlock Section in the Admin Modal.
     */
    function showUnlockSection() {
      document.getElementById('settingsSection').style.display = 'none';
      document.getElementById('unlockSection').style.display = 'block';
    }
  
    /**
     * Handles the keyboard shortcut for opening the Admin Modal.
     * Changed from Ctrl + B to Ctrl + Shift + B to avoid browser conflicts.
     */
    document.addEventListener('keydown', function (event) {
      // Use Ctrl + Shift + B instead of Ctrl + B
      if (event.ctrlKey && event.shiftKey && (event.key === 'B' || event.key === 'b')) {
        event.preventDefault();
        openAdminModal();
        console.log('Admin Modal opened via Ctrl + Shift + B');
      }
    });
  
    /**
     * Closes the Admin Modal when clicking outside of the modal content.
     */
    window.onclick = function(event) {
      const modal = document.getElementById('adminModal');
      if (event.target == modal) {
        closeAdminModal();
      }
    }
  </script>
  
  <!-- Initialize the UI -->
  <script>
    /**
     * Initializes the UI by fetching sales options from the server.
     */
    initialize();
  </script>
</body>
</html>
